<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš½ Campionato Live - Risultati in Tempo Reale</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header>
            <h1>âš½ Campionato Live 2025/2026</h1>
            <p class="subtitle">Calendario e Risultati in Tempo Reale</p>
            <div id="connection-status" class="status-disconnected">
                ğŸ”´ Disconnesso
            </div>
            <div id="matchday-info" class="matchday-info">
                Giornata: <span id="current-matchday">1</span>
            </div>
        </header>

        <!-- MATCHES -->
        <div id="matches-container">
            <p class="loading">Caricamento partite in corso...</p>
        </div>
    </div>

    <script>
        let socket = null;
        let matchesData = {};
        let currentMatchday = 1;

        function connectWebSocket() {
            socket = new WebSocket("ws://localhost:8888/ws");
            
            socket.onopen = () => {
                console.log("âœ… WebSocket connesso");
                const statusEl = document.getElementById("connection-status");
                statusEl.textContent = "ğŸŸ¢ Connesso";
                statusEl.className = "status-connected";
            };
            
            socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                console.log("ğŸ“¨ Messaggio ricevuto:", message.type);
                
                if (message.type === "initial_state") {
                    console.log("ğŸ“‹ Stato iniziale ricevuto");
                    matchesData = message.matches;
                    currentMatchday = message.current_matchday;
                    updateMatchdayInfo();
                    renderAllMatches();
                    
                } else if (message.type === "match_update") {
                    console.log("ğŸ”„ Aggiornamento match ricevuto");
                    
                    if (message.matches) {
                        message.matches.forEach(updatedMatch => {
                            matchesData[updatedMatch.id] = updatedMatch;
                        });
                    }
                    
                    if (message.current_matchday) {
                        currentMatchday = message.current_matchday;
                        updateMatchdayInfo();
                    }
                    
                    renderAllMatches();
                }
            };
            
            socket.onclose = () => {
                console.log("âŒ WebSocket disconnesso");
                const statusEl = document.getElementById("connection-status");
                statusEl.textContent = "ğŸ”´ Disconnesso - Riconnessione...";
                statusEl.className = "status-disconnected";
                setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = (error) => {
                console.error("âŒ Errore WebSocket:", error);
            };
        }

        function updateMatchdayInfo() {
            document.getElementById("current-matchday").textContent = currentMatchday;
        }
        
        function renderAllMatches() {
            const container = document.getElementById("matches-container");
            
            if (Object.keys(matchesData).length === 0) {
                container.innerHTML = '<p class="loading">Nessuna partita disponibile</p>';
                return;
            }
            
            const matchesArray = Object.values(matchesData).filter(m => m.matchday === currentMatchday);
            const liveMatches = matchesArray.filter(m => m.status === "live");
            const finishedMatches = matchesArray.filter(m => m.status === "finished");
            
            let html = "";
            
            if (liveMatches.length > 0) {
                html += '<h2 class="section-title">ğŸ”´ LIVE</h2>';
                liveMatches.forEach(match => {
                    html += createMatchCard(match);
                });
            }
            
            if (finishedMatches.length > 0) {
                html += '<h2 class="section-title">âœ… Terminati</h2>';
                finishedMatches.forEach(match => {
                    html += createMatchCard(match);
                });
            }
            
            if (liveMatches.length === 0 && finishedMatches.length === 0) {
                html = '<p class="loading">Nessuna partita in questa giornata</p>';
            }
            
            container.innerHTML = html;
        }
        
        function createMatchCard(match) {
            let statusClass = "";
            let statusText = "";
            let statusIcon = "";
            
            if (match.status === "live") {
                statusClass = "match-live";
                statusText = "LIVE";
                statusIcon = "ğŸ”´";
            } else if (match.status === "scheduled") {
                statusClass = "match-scheduled";
                statusText = "Programmato";
                statusIcon = "ğŸ“…";
            } else {
                statusClass = "match-finished";
                statusText = "Terminato";
                statusIcon = "âœ…";
            }
            
            const recentEvents = getRecentEvents(match);
            
            return `
                <div class="match-card ${statusClass}" onclick="goToMatch('${match.id}')">
                    <div class="match-header">
                        <div class="match-status">
                            ${statusIcon} ${statusText}
                        </div>
                        <div class="match-time">
                            ${match.status === "live" ? "<span class='time-live'>" + match.minute + "'</span>" : ""}
                            ${match.status === "finished" ? "FT" : ""}
                            ${match.status === "scheduled" ? "---" : ""}
                        </div>
                    </div>
                    
                    <div class="match-teams">
                        <div class="team home">
                            ${match.home}
                        </div>
                        
                        <div class="match-score">
                            ${match.score.home} - ${match.score.away}
                        </div>
                        
                        <div class="team away">
                            ${match.away}
                        </div>
                    </div>
                    
                    <div class="match-events-preview">
                        ${recentEvents}
                    </div>
                    
                    <div class="match-link">
                        ğŸ‘ï¸ Vedi dettagli
                    </div>
                </div>
            `;
        }
        
        function getRecentEvents(match) {
            if (!match.events || match.events.length === 0) {
                return '<span class="no-events">Nessun evento</span>';
            }
            
            const importantEvents = match.events.filter(e => 
                ['goal', 'yellow_card', 'red_card', 'penalty', 'substitution'].includes(e.type)
            );
            
            const lastEvents = importantEvents.slice(-5);
            
            if (lastEvents.length === 0) {
                return '<span class="no-events">Nessun evento importante</span>';
            }
            
            const eventsHTML = lastEvents.map(event => {
                let icon = "";
                
                switch(event.type) {
                    case "goal":
                        icon = "âš½";
                        break;
                    case "yellow_card":
                        icon = "ğŸŸ¨";
                        break;
                    case "red_card":
                        icon = "ğŸŸ¥";
                        break;
                    case "penalty":
                        icon = event.scored ? "âš½ğŸ¯" : "âŒ";
                        break;
                    case "substitution":
                        icon = "ğŸ”";
                        break;
                }
                
                return `<span class="event-icon" title="${event.player} - ${event.minute}'">${icon}</span>`;
            }).join(" ");
            
            return eventsHTML;
        }
        
        function goToMatch(matchId) {
            window.location.href = `/match/${matchId}`;
        }

        window.onload = () => {
            console.log("ğŸš€ Applicazione avviata");
            connectWebSocket();
        };
    </script>
</body>
</html>
